// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  LEARNER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CourseVisibility {
  PUBLIC
  PRIVATE
  RESTRICTED
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ContentType {
  VIDEO
  DOCUMENT
  SCORM
  QUIZ
  ASSIGNMENT
  TEXT
  INTERACTIVE
}

enum EnrollmentStatus {
  ENROLLED
  IN_PROGRESS
  COMPLETED
  FAILED
  WITHDRAWN
}

enum EnrollmentType {
  SELF_ENROLLED
  ASSIGNED
  MANDATORY
}

enum LessonProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
  MATCHING
  FILL_BLANK
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  passwordHash  String?
  firstName     String
  lastName      String
  avatarUrl     String?
  role          UserRole   @default(LEARNER)
  status        UserStatus @default(ACTIVE)
  departmentId  String?
  managerId     String?
  lastLogin     DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  metadata      Json?

  department           Department?          @relation("DepartmentUsers", fields: [departmentId], references: [id])
  manager              User?                @relation("UserManager", fields: [managerId], references: [id])
  managedUsers         User[]               @relation("UserManager")
  enrollments          Enrollment[]
  lessonProgress       LessonProgress[]
  quizAttempts         QuizAttempt[]
  certificates         UserCertificate[]
  badges               UserBadge[]
  points               UserPoints?
  notifications        Notification[]
  activityLogs         ActivityLog[]
  coursesCreated       Course[]
  learningPathsCreated LearningPath[]
  assignedEnrollments  Enrollment[]         @relation("AssignedBy")
  bookmarks            Bookmark[]

  @@index([email])
  @@index([departmentId])
  @@index([role])
}

model Department {
  id          String       @id @default(uuid())
  name        String
  parentId    String?
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children Department[] @relation("DepartmentHierarchy")
  users    User[]       @relation("DepartmentUsers")

  @@index([parentId])
}

model Category {
  id       String   @id @default(uuid())
  name     String
  slug     String   @unique
  parentId String?
  icon     String?
  order    Int      @default(0)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  courses  Course[]

  @@index([slug])
  @@index([parentId])
}

model Course {
  id               String            @id @default(uuid())
  title            String
  slug             String            @unique
  description      String?
  thumbnail        String?
  instructorId     String
  categoryId       String?
  status           CourseStatus      @default(DRAFT)
  visibility       CourseVisibility  @default(PUBLIC)
  durationMinutes  Int?
  difficultyLevel  DifficultyLevel?
  tags             String[]
  metadata         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  publishedAt      DateTime?

  instructor      User              @relation(fields: [instructorId], references: [id])
  category        Category?         @relation(fields: [categoryId], references: [id])
  lessons         Lesson[]
  enrollments     Enrollment[]
  certificate     Certificate?
  learningPathItems LearningPathItem[]
  bookmarks       Bookmark[]

  @@index([slug])
  @@index([instructorId])
  @@index([categoryId])
  @@index([status])
}

model Lesson {
  id              String      @id @default(uuid())
  courseId        String
  title           String
  description     String?
  contentType     ContentType
  contentUrl      String?
  contentData     Json?
  durationMinutes Int?
  order           Int
  isRequired      Boolean     @default(true)
  allowDownload   Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz     Quiz?
  progress LessonProgress[]

  @@index([courseId])
  @@index([order])
}

model Quiz {
  id                     String    @id @default(uuid())
  lessonId               String    @unique
  title                  String
  description            String?
  passingScore           Int       @default(70)
  timeLimitMinutes       Int?
  attemptsAllowed        Int?
  randomizeQuestions     Boolean   @default(false)
  showCorrectAnswers     Boolean   @default(true)
  showResultsImmediately Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  lesson    Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]

  @@index([lessonId])
}

model Question {
  id           String       @id @default(uuid())
  quizId       String
  questionText String
  questionType QuestionType
  points       Int          @default(1)
  order        Int
  options      Json?
  correctAnswer String?
  explanation  String?
  createdAt    DateTime     @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([order])
}

model Enrollment {
  id                 String           @id @default(uuid())
  userId             String
  courseId           String
  enrolledAt         DateTime         @default(now())
  startedAt          DateTime?
  completedAt        DateTime?
  status             EnrollmentStatus @default(ENROLLED)
  progressPercentage Int              @default(0)
  dueDate            DateTime?
  enrollmentType     EnrollmentType   @default(SELF_ENROLLED)
  assignedBy         String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user              User              @relation(fields: [userId], references: [id])
  course            Course            @relation(fields: [courseId], references: [id])
  assigner          User?             @relation("AssignedBy", fields: [assignedBy], references: [id])
  lessonProgress    LessonProgress[]
  quizAttempts      QuizAttempt[]
  userCertificates  UserCertificate[]

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

model LessonProgress {
  id              String               @id @default(uuid())
  enrollmentId    String
  lessonId        String
  userId          String
  status          LessonProgressStatus @default(NOT_STARTED)
  startedAt       DateTime?
  completedAt     DateTime?
  timeSpentSeconds Int                 @default(0)
  lastPosition    Int?
  attempts        Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@unique([enrollmentId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model QuizAttempt {
  id               String    @id @default(uuid())
  userId           String
  quizId           String
  enrollmentId     String
  attemptNumber    Int
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  scorePercentage  Int?
  passed           Boolean?
  answers          Json
  timeSpentSeconds Int       @default(0)

  user       User       @relation(fields: [userId], references: [id])
  quiz       Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([enrollmentId])
}

model Certificate {
  id           String    @id @default(uuid())
  courseId     String    @unique
  templateHtml String
  isActive     Boolean   @default(true)
  expiryMonths Int?
  createdAt    DateTime  @default(now())

  course            Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userCertificates  UserCertificate[]
}

model UserCertificate {
  id                String   @id @default(uuid())
  certificateId     String
  userId            String
  enrollmentId      String
  issuedAt          DateTime @default(now())
  expiresAt         DateTime?
  certificateUrl    String?
  verificationCode  String   @unique

  certificate Certificate @relation(fields: [certificateId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  enrollment  Enrollment  @relation(fields: [enrollmentId], references: [id])

  @@index([userId])
  @@index([verificationCode])
}

model LearningPath {
  id          String   @id @default(uuid())
  title       String
  description String?
  thumbnail   String?
  status      CourseStatus @default(DRAFT)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User               @relation(fields: [createdById], references: [id])
  items     LearningPathItem[]

  @@index([createdById])
}

model LearningPathItem {
  id              String  @id @default(uuid())
  learningPathId  String
  courseId        String
  order           Int
  isRequired      Boolean @default(true)

  learningPath LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  course       Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([learningPathId])
  @@index([courseId])
}

model Badge {
  id          String   @id @default(uuid())
  name        String
  description String?
  iconUrl     String?
  criteria    Json
  points      Int      @default(0)
  createdAt   DateTime @default(now())

  userBadges UserBadge[]
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@index([userId])
  @@index([badgeId])
}

model UserPoints {
  id        String   @id @default(uuid())
  userId    String   @unique
  points    Int      @default(0)
  level     Int      @default(1)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  linkUrl   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}
