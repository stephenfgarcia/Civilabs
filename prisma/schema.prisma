// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  LEARNER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CourseVisibility {
  PUBLIC
  PRIVATE
  RESTRICTED
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ContentType {
  VIDEO
  DOCUMENT
  SCORM
  QUIZ
  ASSIGNMENT
  TEXT
  INTERACTIVE
}

enum EnrollmentStatus {
  ENROLLED
  IN_PROGRESS
  COMPLETED
  FAILED
  WITHDRAWN
}

enum EnrollmentType {
  SELF_ENROLLED
  ASSIGNED
  MANDATORY
}

enum LessonProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
  MATCHING
  FILL_BLANK
}

enum DiscussionStatus {
  OPEN
  CLOSED
  PINNED
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  GRADED
  LATE
  RETURNED
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  passwordHash  String?
  firstName     String
  lastName      String
  avatarUrl     String?
  role          UserRole   @default(LEARNER)
  status        UserStatus @default(ACTIVE)
  departmentId  String?
  managerId     String?
  lastLogin     DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  metadata      Json?

  department           Department?          @relation("DepartmentUsers", fields: [departmentId], references: [id])
  manager              User?                @relation("UserManager", fields: [managerId], references: [id])
  managedUsers         User[]               @relation("UserManager")
  enrollments          Enrollment[]
  lessonProgress       LessonProgress[]
  quizAttempts         QuizAttempt[]
  certificates         UserCertificate[]
  badges               UserBadge[]
  points               UserPoints?
  notifications        Notification[]
  notificationPreference NotificationPreference?
  activityLogs         ActivityLog[]
  coursesCreated       Course[]
  learningPathsCreated LearningPath[]
  assignedEnrollments  Enrollment[]         @relation("AssignedBy")
  bookmarks            Bookmark[]
  discussionThreads    DiscussionThread[]
  discussionReplies    DiscussionReply[]
  discussionLikes      DiscussionLike[]
  courseReviews        CourseReview[]
  reviewLikes          ReviewLike[]
  conversationsAsUser1 Conversation[]       @relation("ConversationUser1")
  conversationsAsUser2 Conversation[]       @relation("ConversationUser2")
  messagesSent         Message[]
  assignmentsCreated   Assignment[]
  assignmentSubmissions AssignmentSubmission[]

  @@index([email])
  @@index([departmentId])
  @@index([role])
}

model Department {
  id          String       @id @default(uuid())
  name        String
  parentId    String?
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children Department[] @relation("DepartmentHierarchy")
  users    User[]       @relation("DepartmentUsers")

  @@index([parentId])
}

model Category {
  id       String   @id @default(uuid())
  name     String
  slug     String   @unique
  parentId String?
  icon     String?
  order    Int      @default(0)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  courses  Course[]

  @@index([slug])
  @@index([parentId])
}

model Course {
  id               String            @id @default(uuid())
  title            String
  slug             String            @unique
  description      String?
  thumbnail        String?
  instructorId     String
  categoryId       String?
  status           CourseStatus      @default(DRAFT)
  visibility       CourseVisibility  @default(PUBLIC)
  durationMinutes  Int?
  difficultyLevel  DifficultyLevel?
  tags             String[]
  metadata         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  publishedAt      DateTime?

  instructor      User              @relation(fields: [instructorId], references: [id])
  category        Category?         @relation(fields: [categoryId], references: [id])
  lessons         Lesson[]
  enrollments     Enrollment[]
  certificate     Certificate?
  learningPathItems LearningPathItem[]
  bookmarks       Bookmark[]
  discussions     DiscussionThread[]
  reviews         CourseReview[]
  assignments     Assignment[]

  @@index([slug])
  @@index([instructorId])
  @@index([categoryId])
  @@index([status])
}

model Lesson {
  id              String      @id @default(uuid())
  courseId        String
  title           String
  description     String?
  contentType     ContentType
  contentUrl      String?
  contentData     Json?
  durationMinutes Int?
  order           Int
  isRequired      Boolean     @default(true)
  allowDownload   Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz     Quiz?
  progress LessonProgress[]

  @@index([courseId])
  @@index([order])
}

model Quiz {
  id                     String    @id @default(uuid())
  lessonId               String    @unique
  title                  String
  description            String?
  passingScore           Int       @default(70)
  timeLimitMinutes       Int?
  attemptsAllowed        Int?
  randomizeQuestions     Boolean   @default(false)
  showCorrectAnswers     Boolean   @default(true)
  showResultsImmediately Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  lesson    Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]

  @@index([lessonId])
}

model Question {
  id           String       @id @default(uuid())
  quizId       String
  questionText String
  questionType QuestionType
  points       Int          @default(1)
  order        Int
  options      Json?
  correctAnswer String?
  explanation  String?
  createdAt    DateTime     @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([order])
}

model Enrollment {
  id                 String           @id @default(uuid())
  userId             String
  courseId           String
  enrolledAt         DateTime         @default(now())
  startedAt          DateTime?
  completedAt        DateTime?
  status             EnrollmentStatus @default(ENROLLED)
  progressPercentage Int              @default(0)
  dueDate            DateTime?
  enrollmentType     EnrollmentType   @default(SELF_ENROLLED)
  assignedBy         String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user              User              @relation(fields: [userId], references: [id])
  course            Course            @relation(fields: [courseId], references: [id])
  assigner          User?             @relation("AssignedBy", fields: [assignedBy], references: [id])
  lessonProgress    LessonProgress[]
  quizAttempts      QuizAttempt[]
  userCertificates  UserCertificate[]

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

model LessonProgress {
  id              String               @id @default(uuid())
  enrollmentId    String
  lessonId        String
  userId          String
  status          LessonProgressStatus @default(NOT_STARTED)
  startedAt       DateTime?
  completedAt     DateTime?
  timeSpentSeconds Int                 @default(0)
  lastPosition    Int?
  attempts        Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@unique([enrollmentId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model QuizAttempt {
  id               String    @id @default(uuid())
  userId           String
  quizId           String
  enrollmentId     String
  attemptNumber    Int
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  scorePercentage  Int?
  passed           Boolean?
  answers          Json
  timeSpentSeconds Int       @default(0)

  user       User       @relation(fields: [userId], references: [id])
  quiz       Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([enrollmentId])
}

model Certificate {
  id           String    @id @default(uuid())
  courseId     String    @unique
  templateHtml String
  isActive     Boolean   @default(true)
  expiryMonths Int?
  createdAt    DateTime  @default(now())

  course            Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userCertificates  UserCertificate[]
}

model UserCertificate {
  id                String   @id @default(uuid())
  certificateId     String
  userId            String
  enrollmentId      String
  issuedAt          DateTime @default(now())
  expiresAt         DateTime?
  certificateUrl    String?
  verificationCode  String   @unique

  certificate Certificate @relation(fields: [certificateId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  enrollment  Enrollment  @relation(fields: [enrollmentId], references: [id])

  @@index([userId])
  @@index([verificationCode])
}

model LearningPath {
  id          String   @id @default(uuid())
  title       String
  description String?
  thumbnail   String?
  status      CourseStatus @default(DRAFT)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User               @relation(fields: [createdById], references: [id])
  items     LearningPathItem[]

  @@index([createdById])
}

model LearningPathItem {
  id              String  @id @default(uuid())
  learningPathId  String
  courseId        String
  order           Int
  isRequired      Boolean @default(true)

  learningPath LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  course       Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([learningPathId])
  @@index([courseId])
}

model Badge {
  id          String   @id @default(uuid())
  name        String
  description String?
  iconUrl     String?
  criteria    Json
  points      Int      @default(0)
  createdAt   DateTime @default(now())

  userBadges UserBadge[]
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@index([userId])
  @@index([badgeId])
}

model UserPoints {
  id        String   @id @default(uuid())
  userId    String   @unique
  points    Int      @default(0)
  level     Int      @default(1)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  linkUrl   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

model NotificationPreference {
  id                   String   @id @default(uuid())
  userId               String   @unique
  emailNotifications   Boolean  @default(true)
  pushNotifications    Boolean  @default(true)
  courseUpdates        Boolean  @default(true)
  discussionReplies    Boolean  @default(true)
  achievements         Boolean  @default(true)
  systemAnnouncements  Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model DiscussionThread {
  id        String            @id @default(uuid())
  title     String
  content   String
  courseId  String?
  userId    String
  status    DiscussionStatus  @default(OPEN)
  isPinned  Boolean           @default(false)
  isLocked  Boolean           @default(false)
  isSolved  Boolean           @default(false)
  isFlagged Boolean           @default(false)
  viewCount Int               @default(0)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user    User              @relation(fields: [userId], references: [id])
  course  Course?           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  replies DiscussionReply[]
  likes   DiscussionLike[]

  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([createdAt])
}

model DiscussionReply {
  id        String   @id @default(uuid())
  threadId  String
  userId    String
  content   String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  thread  DiscussionThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user    User              @relation(fields: [userId], references: [id])
  parent  DiscussionReply?  @relation("ReplyThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies DiscussionReply[] @relation("ReplyThread")
  likes   DiscussionLike[]

  @@index([threadId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

model DiscussionLike {
  id        String   @id @default(uuid())
  userId    String
  threadId  String?
  replyId   String?
  createdAt DateTime @default(now())

  user   User              @relation(fields: [userId], references: [id])
  thread DiscussionThread? @relation(fields: [threadId], references: [id], onDelete: Cascade)
  reply  DiscussionReply?  @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
  @@unique([userId, replyId])
  @@index([userId])
  @@index([threadId])
  @@index([replyId])
}

model CourseReview {
  id         String   @id @default(uuid())
  courseId   String
  userId     String
  rating     Int
  comment    String?
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  course Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id])
  likes  ReviewLike[]

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

model ReviewLike {
  id        String   @id @default(uuid())
  reviewId  String
  userId    String
  createdAt DateTime @default(now())

  review CourseReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id])

  @@unique([userId, reviewId])
  @@index([reviewId])
  @@index([userId])
}

model Conversation {
  id            String   @id @default(uuid())
  participant1  String
  participant2  String
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())

  user1    User      @relation("ConversationUser1", fields: [participant1], references: [id])
  user2    User      @relation("ConversationUser2", fields: [participant2], references: [id])
  messages Message[]

  @@unique([participant1, participant2])
  @@index([participant1])
  @@index([participant2])
  @@index([lastMessageAt])
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  status         MessageStatus @default(SENT)
  createdAt      DateTime      @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([status])
  @@index([createdAt])
}

model Assignment {
  id               String            @id @default(uuid())
  title            String
  description      String?
  instructions     String
  courseId         String
  instructorId     String
  status           AssignmentStatus  @default(DRAFT)
  dueDate          DateTime?
  maxPoints        Int               @default(100)
  allowLateSubmission Boolean        @default(false)
  attachmentUrl    String?
  metadata         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  publishedAt      DateTime?

  course      Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor  User                    @relation(fields: [instructorId], references: [id])
  submissions AssignmentSubmission[]

  @@index([courseId])
  @@index([instructorId])
  @@index([status])
  @@index([dueDate])
}

model AssignmentSubmission {
  id              String           @id @default(uuid())
  assignmentId    String
  userId          String
  content         String?
  fileUrl         String?
  status          SubmissionStatus @default(NOT_SUBMITTED)
  submittedAt     DateTime?
  grade           Int?
  feedback        String?
  gradedAt        DateTime?
  gradedBy        String?
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@unique([assignmentId, userId])
  @@index([assignmentId])
  @@index([userId])
  @@index([status])
  @@index([submittedAt])
}
